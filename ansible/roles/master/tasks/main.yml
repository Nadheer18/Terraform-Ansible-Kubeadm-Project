---
# Check if master already initialized
- name: Ensure K8s admin.conf presence check
  stat:
    path: /etc/kubernetes/admin.conf
  register: admin_conf

# Run kubeadm init only if cluster is not initialized
- name: Initialize Kubernetes master (kubeadm init) if not exists
  command: >
    kubeadm init
    --apiserver-advertise-address={{ ansible_default_ipv4.address }}
    --pod-network-cidr={{ pod_network_cidr }}
  register: kubeadm_init
  when: not admin_conf.stat.exists

# Prepare kubeconfig directory
- name: Ensure kube config for ubuntu user
  file:
    path: /home/ubuntu/.kube
    state: directory
    mode: '0755'
    owner: ubuntu
    group: ubuntu

# Copy admin.conf so ubuntu user can use kubectl
- name: Copy admin.conf to ubuntu kube config
  copy:
    src: /etc/kubernetes/admin.conf
    dest: /home/ubuntu/.kube/config
    owner: ubuntu
    group: ubuntu
    mode: '0644'
    remote_src: yes

- name: Ensure kube config directory for root
  file:
    path: /root/.kube
    state: directory
    mode: '0700'

- name: Copy admin.conf to root kube config
  copy:
    src: /etc/kubernetes/admin.conf
    dest: /root/.kube/config
    owner: root
    group: root
    mode: '0600'
    remote_src: yes

# Wait until kube-apiserver is up and responding
- name: Wait for kube-apiserver to be healthy
  shell: |
    export KUBECONFIG=/etc/kubernetes/admin.conf
    kubectl get nodes --no-headers
  register: kubectl_ready
  retries: 20
  delay: 10
  until: kubectl_ready.rc == 0

# Apply Flannel CNI
- name: Ensure flannel manifest applied (idempotent)
  shell: |
    export KUBECONFIG=/etc/kubernetes/admin.conf
    kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml
  args:
    executable: /bin/bash

# Wait for Flannel pods to be ready
- name: Wait for flannel pods ready
  shell: |
    export KUBECONFIG=/etc/kubernetes/admin.conf
    kubectl -n kube-system wait --for=condition=Ready pod -l app=flannel --timeout=180s || true
  args:
    executable: /bin/bash

# Always generate join command (idempotent)
- name: Generate fresh join command
  shell: kubeadm token create --print-join-command
  register: fresh_join_cmd

# Save join command for workers
- name: Save join command to /tmp/kubeadm_join.sh
  copy:
    content: |
      #!/bin/bash
      {{ fresh_join_cmd.stdout }}
    dest: /tmp/kubeadm_join.sh
    mode: '0755'

