---
# Install MetalLB (idempotent)
- name: Ensure metallb namespace exists (install if absent)
  shell: |
    export KUBECONFIG=/etc/kubernetes/admin.conf
    kubectl get ns {{ metallb_namespace }} || \
    kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.14.5/config/manifests/metallb-native.yaml
  args:
    executable: /bin/bash

# Wait for MetalLB pods to be ready
- name: Wait for metallb pods ready
  shell: |
    export KUBECONFIG=/etc/kubernetes/admin.conf
    kubectl -n {{ metallb_namespace }} wait --for=condition=Ready pod --all --timeout=180s || true
  args:
    executable: /bin/bash

# Create MetalLB IP Pool manifest
- name: Create MetalLB IPAddressPool manifest
  copy:
    dest: /tmp/metallb-ip-pool.yaml
    content: |
      apiVersion: metallb.io/v1beta1
      kind: IPAddressPool
      metadata:
        name: public-ip-pool
        namespace: {{ metallb_namespace }}
      spec:
        addresses:
          - {{ metallb_ip_pool }}

# Create MetalLB L2Advertisement manifest
- name: Create MetalLB L2Advertisement manifest
  copy:
    dest: /tmp/metallb-l2.yaml
    content: |
      apiVersion: metallb.io/v1beta1
      kind: L2Advertisement
      metadata:
        name: l2-advertisement
        namespace: {{ metallb_namespace }}
      spec:
        ipAddressPools:
          - public-ip-pool

# Apply MetalLB configuration
- name: Apply MetalLB manifests
  shell: |
    export KUBECONFIG=/etc/kubernetes/admin.conf
    kubectl apply -f /tmp/metallb-ip-pool.yaml
    kubectl apply -f /tmp/metallb-l2.yaml
  args:
    executable: /bin/bash

# Install Ingress-NGINX
- name: Install Ingress-NGINX
  shell: |
    export KUBECONFIG=/etc/kubernetes/admin.conf
    kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/cloud/deploy.yaml
  args:
    executable: /bin/bash

# Wait until Ingress controller pods are ready
- name: Wait for ingress controller ready
  shell: |
    export KUBECONFIG=/etc/kubernetes/admin.conf
    kubectl -n {{ ingress_namespace }} wait --for=condition=Ready pod --all --timeout=180s || true
  args:
    executable: /bin/bash

# Show nodes
- name: Show cluster nodes
  shell: |
    export KUBECONFIG=/etc/kubernetes/admin.conf
    kubectl get nodes -o wide
  args:
    executable: /bin/bash
  register: nodes_output

# Print nodes output
- name: Print node status
  debug:
    var: nodes_output.stdout_lines

