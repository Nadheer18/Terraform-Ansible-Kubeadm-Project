---
# Wait until /tmp/kubeadm_join.sh exists on master
- name: Wait for join file to be available on master (retry)
  wait_for:
    path: /tmp/kubeadm_join.sh
    host: "{{ groups['master'][0] }}"
    timeout: 300
  delegate_to: "{{ groups['master'][0] }}"
  run_once: true

# Read the join script from master
- name: Slurp join script from master
  slurp:
    src: /tmp/kubeadm_join.sh
  delegate_to: "{{ groups['master'][0] }}"
  run_once: true
  register: join_slurp

# Extract join command (last line of file)
- name: Set join_cmd fact
  set_fact:
    join_cmd: "{{ (join_slurp.content | b64decode).splitlines()[-1] | trim }}"

# Quick kubeadm check (doesn't affect join)
- name: Check if kubeadm is installed
  shell: kubeadm version --client
  register: kubeadm_check
  failed_when: false
  changed_when: false

# Join worker to cluster
- name: Join the worker node to the cluster
  shell: |
    {{ join_cmd }}
  args:
    executable: /bin/bash
  register: join_result
  ignore_errors: true

# Print join result (for debugging)
- name: Show join command result
  debug:
    var: join_result.stdout_lines

